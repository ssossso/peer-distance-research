{% extends "base.html" %}
{% block content %}
<div class="card">
  <h2>연구/관리 데이터</h2>
  <div style="margin-top:6px; color:#6b7280; font-size:14px;">
    이 페이지는 연구자(관리자) 전용입니다. (엑셀 내보내기 포함)
  </div>

  {% if not db_ready %}
    <hr style="margin:16px 0;">
    <div class="error">
      현재 DB 연결이 설정되지 않아(또는 사용 중이 아니라) 연구 데이터 조회/내보내기를 사용할 수 없습니다.<br>
      Render 환경변수 DATABASE_URL 설정 후 다시 시도해 주세요.
    </div>

    <hr style="margin:16px 0;">
    <h3 style="margin:0 0 8px 0;">프레임(추후 연결 예정)</h3>
    <ul style="margin:0; padding-left:18px; color:#6b7280;">
      <li>‘이번 회차 분석 결과 저장’ 전송 로그(전송일시) 조회</li>
      <li>분석 스냅샷(학생 평균/MDS/K-means 요약) 다운로드</li>
      <li>교사 사후 검사(확신도/인식 변화 체크) 결과 다운로드</li>
    </ul>
  {% else %}
    <hr style="margin:16px 0;">

    <h3 style="margin:0 0 10px 0;">학급 목록</h3>

    {% if overview|length == 0 %}
      <div style="color:#6b7280;">DB에 학급 데이터가 없습니다.</div>
    {% endif %}

    {% for c in overview %}
      <div class="card" style="margin-top:12px; background:#fafafa;">
        <div style="display:flex; justify-content:space-between; gap:12px; flex-wrap:wrap;">
          <div>
            <div style="font-weight:700;">
              {{ c.name }} <span style="color:#6b7280; font-weight:500;">({{ c.code }})</span>
            </div>
            <div style="color:#6b7280; font-size:13px; margin-top:4px;">
              teacher: {{ c.teacher_username }} · students: {{ c.student_count }}
              {% if c.created_at %} · created: {{ c.created_at.strftime("%Y-%m-%d %H:%M") }}{% endif %}
            </div>
          </div>
        </div>

        <hr style="margin:12px 0;">

        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:14px;">
          <div>
            <div style="font-weight:700; margin-bottom:6px;">학생 세션(학생 배치)</div>
            {% if c.student_sessions|length == 0 %}
              <div style="color:#6b7280; font-size:13px;">(데이터 없음)</div>
            {% else %}
              <table style="width:100%; border-collapse:collapse; font-size:13px;">
                <thead>
                  <tr style="text-align:left; color:#6b7280;">
                    <th style="padding:6px 0;">차시(sid)</th>
                    <th style="padding:6px 0;">제출/전체</th>
                    <th style="padding:6px 0;">엑셀</th>
                  </tr>
                </thead>
                <tbody>
                  {% for s in c.student_sessions %}
                  <tr>
                    <td style="padding:6px 0;">{{ s.sid }}</td>
                    <td style="padding:6px 0;">{{ s.submitted }}/{{ s.total }}</td>
                    <td style="padding:6px 0;">
                      <a href="/research/export/student_sessions.xlsx?class_code={{ c.code }}&sid={{ s.sid }}"
                         style="text-decoration:underline;">내보내기</a>
                    </td>
                  </tr>
                  {% endfor %}
                </tbody>
              </table>
            {% endif %}
          </div>

          <div>
            <div style="font-weight:700; margin-bottom:6px;">교사 런(교사 배치/판단)</div>
            {% if c.teacher_runs|length == 0 %}
              <div style="color:#6b7280; font-size:13px;">(데이터 없음)</div>
            {% else %}
              <table style="width:100%; border-collapse:collapse; font-size:13px;">
                <thead>
                  <tr style="text-align:left; color:#6b7280;">
                    <th style="padding:6px 0;">차시(session_id)</th>
                    <th style="padding:6px 0;">제출/전체</th>
                    <th style="padding:6px 0;">엑셀</th>
                  </tr>
                </thead>
                <tbody>
                  {% for t in c.teacher_runs %}
                  <tr>
                    <td style="padding:6px 0;">{{ t.session_id }}</td>
                    <td style="padding:6px 0;">{{ t.submitted }}/{{ t.total }}</td>
                    <td style="padding:6px 0;">
                      <a href="/research/export/teacher_runs.xlsx?class_code={{ c.code }}&session_id={{ t.session_id }}"
                         style="text-decoration:underline;">내보내기</a>
                    </td>
                  </tr>
                  {% endfor %}
                </tbody>
              </table>
            {% endif %}
          </div>
        </div>

        <hr style="margin:12px 0;">

        <div style="font-weight:700; margin-bottom:6px;">추후 연결 예정(프레임)</div>
        <ul style="margin:0; padding-left:18px; color:#6b7280; font-size:13px;">
          <li>‘이번 회차 분석 결과 저장’ 전송 로그(전송일시) 조회/다운로드</li>
          <li>분석 스냅샷: 학생 평균 거리행렬 / MDS 좌표 / K-means 요약 저장본</li>
          <li>교사 사후 검사: 확신도(전/후), 인식 변화 체크, 추가 주목 학생(선택) 내보내기</li>
        </ul>
      </div>
    {% endfor %}
  {% endif %}
</div>
{% endblock %}
