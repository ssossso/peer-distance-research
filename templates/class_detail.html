{% extends "base.html" %}
{% block content %}
<div class="card" style="text-align:left;">
  <h2 style="text-align:center;">{{ cls.name }}</h2>
  <p style="text-align:center;">í•™ê¸‰ ì½”ë“œ: <b>{{ code }}</b></p>

  <!-- êµì‚¬ ë°°ì¹˜ ì‹œì‘ ë²„íŠ¼: ë¡œê·¸ì¸í•œ êµì‚¬ì—ê²Œë§Œ ë…¸ì¶œ -->
  {% if session.get("teacher") %}
  <div style="display:flex; justify-content:center; gap:10px; margin:10px 0 6px 0;">
    <a
      class="pill"
      href="/teacher/class/{{ code }}/placement/start?sid={{ sid }}"
      style="text-decoration:none; display:inline-block;"
      title="êµì‚¬ ê´€ê³„ êµ¬ì¡° ë°°ì¹˜ ì‹œì‘"
      aria-label="êµì‚¬ ê´€ê³„ êµ¬ì¡° ë°°ì¹˜ ì‹œì‘"
    >
      êµì‚¬ ë°°ì¹˜ ì‹œì‘
    </a>
  </div>
  {% endif %}

  <div style="display:flex; justify-content:space-between; align-items:center; gap:10px; margin:12px 0;">
    <div style="font-weight:800;">ì¸¡ì • íšŒì°¨</div>
    <form method="get" action="" style="display:flex; gap:8px; align-items:center;">
      <select name="sid" onchange="this.form.submit();" style="padding:8px 10px; border-radius:10px; border:1px solid #d1d5db;">
        {% for _sid, meta in cls.sessions|dictsort(true) %}
          <option value="{{ _sid }}" {% if (_sid|string) == (sid|string) %}selected{% endif %}>
            {{ meta.label if meta.label else (_sid ~ 'ì°¨') }}
          </option>
        {% endfor %}
      </select>
    </form>
  </div>

  <div class="subtitle" style="margin:0 0 8px 0;">
    í•™ìƒì€ íšŒì°¨ë¥¼ ì„ íƒí•˜ì§€ ì•Šê³ , ì•„ë˜ì˜ <b>íšŒì°¨ë³„ ë§í¬</b>ë¡œ ì…ì¥í•©ë‹ˆë‹¤.
  </div>

  <div class="card" style="background:#f8fafc; margin:10px 0 14px 0;">
    <div style="font-weight:900; margin-bottom:8px;">QR ì½”ë“œë¡œ ë°°í¬í•˜ê¸°</div>
    <div class="subtitle" style="margin:0 0 10px 0;">
      ê° íšŒì°¨ QRì„ í•™ìƒë“¤ì—ê²Œ ë³´ì—¬ì£¼ê±°ë‚˜ ì¸ì‡„í•´ì„œ ë°°í¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
    </div>

    <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap:12px;">
      {% for s in session_links %}
        {% set qr_src = '/qr/' ~ code ~ '/' ~ s.sid ~ '.png' %}
        <div style="background:white; border:1px solid #e5e7eb; border-radius:14px; padding:10px; text-align:center;">
          <div style="font-weight:900; margin-bottom:6px;">{{ s.label }}</div>

          <!-- QR ì´ë¯¸ì§€ -->
          <img
            src="{{ qr_src }}"
            alt="{{ s.label }} QR"
            style="width:120px; height:120px; border-radius:8px; border:1px solid #eef2f7; display:block; margin:0 auto;"
            loading="lazy"
          />

          <!-- QR ì•„ë˜ ì•„ì´ì½˜ (ë§í¬ ìœ„) -->
          <div style="display:flex; gap:8px; justify-content:center; align-items:center; margin-top:8px; margin-bottom:6px;">
            <!-- í™•ëŒ€ ë³´ê¸°: ìƒˆ ì°½/ìƒˆ íƒ­ìœ¼ë¡œë§Œ ì—´ê¸° (í˜„ì¬ í˜ì´ì§€ ë³€í™” ì—†ìŒ) -->
            <button
              type="button"
              title="í¬ê²Œ ë³´ê¸°(ìƒˆ ì°½)"
              aria-label="QR í¬ê²Œ ë³´ê¸°(ìƒˆ ì°½)"
              onclick="openQrNewWindowOnly('{{ qr_src }}')"
              style="width:26px; height:26px; border-radius:10px; border:1px solid #e5e7eb; background:#fff; display:inline-flex; align-items:center; justify-content:center; cursor:pointer; font-size:16px; line-height:1;"
            >ğŸ”</button>

            <!-- ë‹¤ìš´ë¡œë“œ(PNG ì €ì¥) -->
            <button
              type="button"
              title="PNG ë‹¤ìš´ë¡œë“œ"
              aria-label="QR PNG ë‹¤ìš´ë¡œë“œ"
              onclick="downloadQrPng('{{ qr_src }}', '{{ s.label|e }}')"
              style="width:26px; height:26px; border-radius:10px; border:1px solid #e5e7eb; background:#fff; display:inline-flex; align-items:center; justify-content:center; cursor:pointer; font-size:16px; line-height:1;"
            >ğŸ“‚</button>
          </div>

          <!-- nì°¨ ë§í¬ -->
          <div style="margin-top:4px;">
            <a class="pill" href="{{ s.url }}" style="text-decoration:none; display:inline-block;">
              {{ s.label }} ë§í¬
            </a>
          </div>
        </div>
      {% endfor %}
    </div>
  </div>

  <hr>
  <ul>
    {% for r in rows %}
      <li>
        <div class="student-item">
          <div class="student-name"><span class="no">{{ r.no }}</span> {{ r.name }}</div>
          <div class="student-actions">
            <a class="goto-btn" href="/teacher/class/{{ code }}/result/{{ sid }}/{{ r.url_name }}" title="í•™ìƒ ê²°ê³¼ ë³´ê¸°" aria-label="í•™ìƒ ê²°ê³¼ ë³´ê¸°">â†—</a>
            <span class="status">{{ r.status }}</span>
          </div>
        </div>
      </li>
    {% endfor %}
  </ul>
</div>

<script>
  function safeFilename(s){
    return (s || '')
      .trim()
      .replace(/[\\\/:*?"<>|]/g, '')
      .replace(/\s+/g, '_');
  }

  // ì¤‘ìš”: í˜„ì¬ í˜ì´ì§€ëŠ” ì ˆëŒ€ ì´ë™í•˜ì§€ ì•ŠìŒ.
  // íŒì—…ì´ ì°¨ë‹¨ë˜ë©´ "ì•ˆ ì—´ë ¸ìŠµë‹ˆë‹¤" ì•ˆë‚´ë§Œ í•˜ê³  ëëƒ„(ì¤‘ë³µ ë°©ì§€).
  function openQrNewWindowOnly(src){
    const w = window.open(src, '_blank', 'noopener,noreferrer');
    if (!w) {
      alert('ìƒˆ ì°½ì´ ì°¨ë‹¨ë˜ì–´ QRì„ ì—´ ìˆ˜ ì—†ì–´ìš”. ë¸Œë¼ìš°ì €ì—ì„œ íŒì—…ì„ í—ˆìš©í•œ ë’¤ ë‹¤ì‹œ ëˆŒëŸ¬ì£¼ì„¸ìš”.');
    }
  }

  async function downloadQrPng(src, label){
    try {
      const res = await fetch(src, { cache: 'no-store' });
      if (!res.ok) throw new Error('QR fetch failed: ' + res.status);
      const blob = await res.blob();

      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      const nice = safeFilename(label);
      a.download = `qr_${nice || 'qr'}.png`;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    } catch (err) {
      // ìµœí›„ fallback: ìƒˆ íƒ­ ì—´ê¸°(ì‚¬ìš©ìê°€ ì§ì ‘ ì €ì¥ ê°€ëŠ¥)
      window.open(src, '_blank', 'noopener,noreferrer');
    }
  }
</script>
{% endblock %}
