{% extends "base.html" %}
{% block content %}
<div class="card" style="max-width:980px; text-align:left;">
  <h2 style="margin:0 0 6px 0; text-align:center;">연구 분석 ({{ cls.name }})</h2>
  <p style="margin:0 0 14px 0; text-align:center; color:#6b7280; font-weight:800;">
    {{ sid }}차 결과 — 밀집 / 경계 / 고립 구조
  </p>

  <div style="display:flex; gap:10px; justify-content:center; flex-wrap:wrap; margin-bottom:12px;">
    <a class="btn" href="/teacher/class/{{ code }}/v2?sid={{ sid }}&open=1" style="text-decoration:none;">← 회차 화면으로</a>
  </div>

  <div style="border:1px solid #e5e7eb; border-radius:14px; overflow:hidden; background:#fff;">
    <div style="padding:10px 12px; background:#f8fafc; border-bottom:1px solid #eef2f7; font-weight:950;">
      구조 시각화
      <span style="margin-left:8px; color:#6b7280; font-weight:800; font-size:12px;">
        (알고리즘 용어는 숨기고 상태로만 표시)
      </span>
    </div>

    <div style="padding:12px;">
      <canvas id="viz" width="920" height="520" style="width:100%; height:auto; border:1px solid #e5e7eb; border-radius:12px;"></canvas>

      <div id="metrics" style="margin-top:12px; display:grid; grid-template-columns:1fr 1fr 1fr; gap:10px;">
        <div class="card" style="padding:10px; margin:0;">
          <div style="font-weight:950;">밀집</div>
          <div id="m_dense" style="font-size:22px; font-weight:950;">-</div>
        </div>
        <div class="card" style="padding:10px; margin:0;">
          <div style="font-weight:950;">경계</div>
          <div id="m_boundary" style="font-size:22px; font-weight:950;">-</div>
        </div>
        <div class="card" style="padding:10px; margin:0;">
          <div style="font-weight:950;">고립</div>
          <div id="m_isolated" style="font-size:22px; font-weight:950;">-</div>
        </div>
      </div>

      <div id="notes" style="margin-top:10px; padding:10px 12px; background:#fff; border:1px solid #e5e7eb; border-radius:12px; font-weight:800; color:#374151;">
        분석 메모가 여기에 표시됩니다.
      </div>

      <details style="margin-top:10px;">
        <summary style="cursor:pointer; font-weight:950;">분석 설정(연구 재현용)</summary>
        <pre id="params" style="white-space:pre-wrap; font-size:12px; margin-top:8px; background:#0b1020; color:#e5e7eb; padding:10px; border-radius:12px;"></pre>
      </details>
    </div>
  </div>
</div>

<script>
(function(){
  const code = "{{ code }}";
  const sid = "{{ sid }}";
  const url = `/analysis/class/${code}/${sid}/dbscan_structure.json`;

  const canvas = document.getElementById("viz");
  const ctx = canvas.getContext("2d");

  function clear(){
    ctx.clearRect(0, 0, canvas.width, canvas.height);
  }

  // 좌표를 캔버스 안으로 맞추기: bbox 기반 + 여백
  function fit(points){
    if(!points || points.length === 0) return [];
    const xs = points.map(p => p.x);
    const ys = points.map(p => p.y);

    const minx = Math.min(...xs), maxx = Math.max(...xs);
    const miny = Math.min(...ys), maxy = Math.max(...ys);

    const rx = (maxx - minx) || 1;
    const ry = (maxy - miny) || 1;

    const pad = 0.06;
    const W = canvas.width;
    const H = canvas.height;

    return points.map(p => {
      const nx = (p.x - minx) / rx;
      const ny = (p.y - miny) / ry;
      return {
        ...p,
        cx: (pad * W) + nx * (W * (1 - 2 * pad)),
        cy: (pad * H) + ny * (H * (1 - 2 * pad)),
      };
    });
  }

  function drawFog(fogPoints){
    if(!fogPoints || fogPoints.length === 0) return;

    ctx.save();
    ctx.globalAlpha = 0.16;

    // Fog = 집단 수준 구조(밀집점 주변을 부드럽게 누적)
    for(const p of fogPoints){
      const g = ctx.createRadialGradient(p.cx, p.cy, 0, p.cx, p.cy, 70);
      g.addColorStop(0, "rgba(74,108,247,0.55)");
      g.addColorStop(1, "rgba(74,108,247,0.00)");
      ctx.fillStyle = g;
      ctx.beginPath();
      ctx.arc(p.cx, p.cy, 70, 0, Math.PI * 2);
      ctx.fill();
    }

    ctx.restore();
  }

  function drawPoint(p){
    const r = 8;

    // 밀집: 진한 점
    if(p.state === "dense"){
      ctx.save();
      ctx.fillStyle = "#111827";
      ctx.beginPath();
      ctx.arc(p.cx, p.cy, r, 0, Math.PI * 2);
      ctx.fill();
      ctx.restore();
      return;
    }

    // 경계: 흐린 점 + 점선 테두리
    if(p.state === "boundary"){
      ctx.save();
      ctx.fillStyle = "rgba(17,24,39,0.25)";
      ctx.beginPath();
      ctx.arc(p.cx, p.cy, r, 0, Math.PI * 2);
      ctx.fill();

      ctx.setLineDash([4, 3]);
      ctx.strokeStyle = "rgba(17,24,39,0.75)";
      ctx.lineWidth = 2;
      ctx.beginPath();
      ctx.arc(p.cx, p.cy, r + 2, 0, Math.PI * 2);
      ctx.stroke();
      ctx.restore();
      return;
    }

    // 고립: 비어 있는 링
    ctx.save();
    ctx.setLineDash([]);
    ctx.strokeStyle = "rgba(17,24,39,0.9)";
    ctx.lineWidth = 2;
    ctx.beginPath();
    ctx.arc(p.cx, p.cy, r + 2, 0, Math.PI * 2);
    ctx.stroke();
    ctx.restore();
  }

  function render(payload){
    const pts = fit(payload.points || []);
    const fog = fit(payload.fog_points || []);

    clear();
    drawFog(fog);
    for(const p of pts) drawPoint(p);

    const c = payload.counts || {};
    document.getElementById("m_dense").textContent = (c.dense ?? "-");
    document.getElementById("m_boundary").textContent = (c.boundary ?? "-");
    document.getElementById("m_isolated").textContent = (c.isolated ?? "-");

    const notes = payload.notes || [];
    document.getElementById("notes").textContent = notes.length ? notes.join(" / ") : "특이 메모 없음";

    document.getElementById("params").textContent = JSON.stringify(payload.params || {}, null, 2);
  }

  fetch(url)
    .then(r => r.json())
    .then(render)
    .catch(err => {
      clear();
      ctx.fillStyle = "#111827";
      ctx.font = "16px system-ui";
      ctx.fillText("분석 데이터를 불러오지 못했습니다.", 20, 40);
      console.error(err);
    });
})();
</script>
{% endblock %}
