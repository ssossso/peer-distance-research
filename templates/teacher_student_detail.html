{% extends "base.html" %}
{% block content %}
<div class="card" style="text-align:left;">
  <h2 style="text-align:center;">{{ cls.name }}</h2>
  <p style="text-align:center;">
    <b>{% if no %}{{ no }}번 {% endif %}{{ name }}</b>
    <span class="muted" style="margin-left:8px;">{{ session_meta.label if session_meta and session_meta.label else sid ~ '차' }}</span>
    <span class="status" style="margin-left:8px;">{{ status }}</span>
  </p>
  <hr>

  <div style="display:flex; justify-content:space-between; align-items:center; gap:10px; margin:10px 0 14px 0;">
    <div style="font-weight:800;">회차 선택</div>
    <form method="get" action="" style="display:flex; gap:8px; align-items:center;">
      <select name="sid" onchange="this.form.submit();" style="padding:8px 10px; border-radius:10px; border:1px solid #d1d5db;">
        {% for _sid, meta in cls.sessions|dictsort(true) %}
          <option value="{{ _sid }}" {% if _sid == sid %}selected{% endif %}>{{ meta.label if meta.label else (_sid ~ '차') }}</option>
        {% endfor %}
      </select>
    </form>
  </div>

  {% if session_data.submitted %}
    <div style="margin:10px 0 12px 0; font-weight:800;">심리적 거리 배치 결과</div>

    <div id="preview" style="position:relative; height:420px; border:1px solid #d1d5db; border-radius:12px; background:#fff; overflow:hidden;">
      <div style="position:absolute; left:50%; top:50%; transform:translate(-50%,-50%);">
        <div style="width:16px; height:16px; border-radius:999px; background:#4a6cf7; margin:auto;"></div>
        <div style="font-size:12px; font-weight:800; margin-top:6px; text-align:center;">나</div>
      </div>
    </div>

    <div style="margin-top:10px; font-size:13px; color:#374151;">
      <div style="font-weight:800; margin-bottom:6px;">친구별 좌표/거리</div>
      <div style="display:grid; grid-template-columns: 1fr 1fr 1fr; gap:8px;">
        <div style="font-weight:800;">이름</div>
        <div style="font-weight:800;">(x, y)</div>
        <div style="font-weight:800;">거리 d</div>
      </div>
      <div id="tableRows" style="display:flex; flex-direction:column; gap:6px; margin-top:6px;"></div>
    </div>

    <script>
      const placements = {{ (session_data.placements or {})|tojson }};
      const preview = document.getElementById('preview');
      const tableRows = document.getElementById('tableRows');

      function clamp(v, min, max){ return Math.min(Math.max(v, min), max); }

      function render(){
        const rect = preview.getBoundingClientRect();
        const center = { x: rect.width/2, y: rect.height/2 };

        Object.keys(placements).forEach((n) => {
          const v = placements[n] || {};
          const token = document.createElement('div');
          token.style.position = 'absolute';
          token.style.padding = '6px 8px';
          token.style.borderRadius = '10px';
          token.style.border = '1px solid #d1d5db';
          token.style.background = '#ffffff';
          token.style.fontWeight = '800';
          token.style.fontSize = '12px';
          token.style.userSelect = 'none';
          token.textContent = n;
          preview.appendChild(token);

          // 토큰 크기 측정 후 위치 보정
          const px = clamp(center.x + (v.x || 0) - token.offsetWidth/2, 0, rect.width - token.offsetWidth);
          const py = clamp(center.y + (v.y || 0) - token.offsetHeight/2, 0, rect.height - token.offsetHeight);
          token.style.left = px + 'px';
          token.style.top = py + 'px';

          const row = document.createElement('div');
          row.style.display = 'grid';
          row.style.gridTemplateColumns = '1fr 1fr 1fr';
          row.style.gap = '8px';
          row.style.padding = '6px 8px';
          row.style.border = '1px solid #eef2ff';
          row.style.borderRadius = '10px';
          row.style.background = '#fbfbfd';
          row.innerHTML = `<div style="font-weight:700;">${n}</div><div>(${v.x ?? 0}, ${v.y ?? 0})</div><div>${v.d ?? ''}</div>`;
          tableRows.appendChild(row);
        });
      }

      window.addEventListener('load', () => {
        // 렌더링 타이밍 보장
        setTimeout(render, 0);
      });
    </script>
  {% else %}
    <p class="subtitle" style="text-align:left;">아직 제출하지 않았습니다.</p>
  {% endif %}

  <hr>
  <div style="text-align:center;">
    <a class="main-btn" href="/teacher/class/{{ code }}" style="width:220px;">학급 목록으로</a>
  </div>
</div>
{% endblock %}
