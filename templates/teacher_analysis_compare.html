
{% extends "base.html" %}
{% block content %}
<div class="card" style="max-width:980px; text-align:left;">
  <h2 style="margin:0 0 6px 0; text-align:center;">회차 비교 분석 ({{ cls.name }})</h2>
  <p style="margin:0 0 14px 0; text-align:center; color:#6b7280; font-weight:800;">
    1~4차 구조 변화 — 밀집 / 경계 / 고립
  </p>

  <div style="display:flex; gap:10px; justify-content:center; flex-wrap:wrap; margin-bottom:12px;">
    <a class="btn" href="/teacher/class/{{ code }}/v2?sid=1&open=1" style="text-decoration:none;">← 회차 화면으로</a>
    <a class="btn" href="/teacher/class/{{ code }}/analysis?sid=1" style="text-decoration:none;">단일 회차 분석(1차)</a>
  </div>

  <div style="border:1px solid #e5e7eb; border-radius:14px; overflow:hidden; background:#fff;">
    <div style="padding:10px 12px; background:#f8fafc; border-bottom:1px solid #eef2f7; font-weight:950;">
      핵심 지표 변화
      <span style="margin-left:8px; color:#6b7280; font-weight:800; font-size:12px;">
        (알고리즘 용어 없이 상태 기반 비교)
      </span>
    </div>

    <div style="padding:12px;">
      <canvas id="trend" width="920" height="240" style="width:100%; height:auto; border:1px solid #e5e7eb; border-radius:12px;"></canvas>

      <div style="margin-top:12px; overflow:auto;">
        <table style="width:100%; border-collapse:collapse; font-size:14px;">
          <thead>
            <tr style="background:#f8fafc;">
              <th style="text-align:left; padding:10px; border-bottom:1px solid #e5e7eb;">회차</th>
              <th style="text-align:right; padding:10px; border-bottom:1px solid #e5e7eb;">참여</th>
              <th style="text-align:right; padding:10px; border-bottom:1px solid #e5e7eb;">밀집</th>
              <th style="text-align:right; padding:10px; border-bottom:1px solid #e5e7eb;">경계</th>
              <th style="text-align:right; padding:10px; border-bottom:1px solid #e5e7eb;">고립</th>
              <th style="text-align:right; padding:10px; border-bottom:1px solid #e5e7eb;">고립 비율</th>
              <th style="text-align:right; padding:10px; border-bottom:1px solid #e5e7eb;">집단 수</th>
              <th style="text-align:left; padding:10px; border-bottom:1px solid #e5e7eb;">집단 크기</th>
            </tr>
          </thead>
          <tbody id="rows">
            <tr>
              <td colspan="8" style="padding:12px; color:#6b7280;">데이터를 불러오는 중…</td>
            </tr>
          </tbody>
        </table>
      </div>

      <div id="notes" style="margin-top:12px; padding:10px 12px; background:#fff; border:1px solid #e5e7eb; border-radius:12px; font-weight:800; color:#374151;">
        회차별 메모가 여기에 표시됩니다.
      </div>

      <details style="margin-top:10px;">
        <summary style="cursor:pointer; font-weight:950;">재현 정보(파라미터) 보기</summary>
        <pre id="params" style="white-space:pre-wrap; font-size:12px; margin-top:8px; background:#0b1020; color:#e5e7eb; padding:10px; border-radius:12px;"></pre>
      </details>
    </div>
  </div>
</div>

<script>
(function(){
  const code = "{{ code }}";
  const sids = {{ sids | tojson }};

  const tbody = document.getElementById("rows");
  const notesBox = document.getElementById("notes");
  const paramsBox = document.getElementById("params");

  const canvas = document.getElementById("trend");
  const ctx = canvas.getContext("2d");

  function clearTrend(){
    ctx.clearRect(0,0,canvas.width, canvas.height);
  }

  function drawTrend(points){
    // points: [{sid:"1", isoRatio:0.2}, ...]
    clearTrend();

    ctx.save();
    ctx.fillStyle = "#111827";
    ctx.font = "14px system-ui";
    ctx.fillText("고립 비율 변화(회차별)", 14, 22);
    ctx.restore();

    const W = canvas.width;
    const H = canvas.height;

    const padL = 50, padR = 20, padT = 40, padB = 30;
    const plotW = W - padL - padR;
    const plotH = H - padT - padB;

    // y: 0..1
    ctx.save();
    ctx.strokeStyle = "rgba(17,24,39,0.15)";
    for(let i=0;i<=4;i++){
      const y = padT + (plotH * i / 4);
      ctx.beginPath();
      ctx.moveTo(padL, y);
      ctx.lineTo(W - padR, y);
      ctx.stroke();
    }
    ctx.restore();

    // axis labels
    ctx.save();
    ctx.fillStyle = "rgba(17,24,39,0.75)";
    ctx.font = "12px system-ui";
    ctx.fillText("1.0", 14, padT + 4);
    ctx.fillText("0.5", 14, padT + plotH/2 + 4);
    ctx.fillText("0.0", 14, padT + plotH + 4);
    ctx.restore();

    if(!points || points.length === 0) return;

    const xs = points.map((p, idx) => padL + (plotW * (idx / Math.max(1, points.length - 1))));
    const ys = points.map(p => padT + plotH * (1 - (p.isoRatio || 0)));

    // line
    ctx.save();
    ctx.strokeStyle = "#111827";
    ctx.lineWidth = 2;
    ctx.beginPath();
    ctx.moveTo(xs[0], ys[0]);
    for(let i=1;i<xs.length;i++){
      ctx.lineTo(xs[i], ys[i]);
    }
    ctx.stroke();
    ctx.restore();

    // dots + x labels
    ctx.save();
    ctx.fillStyle = "#111827";
    ctx.font = "12px system-ui";
    for(let i=0;i<xs.length;i++){
      ctx.beginPath();
      ctx.arc(xs[i], ys[i], 4, 0, Math.PI*2);
      ctx.fill();

      const label = points[i].sid + "차";
      ctx.fillText(label, xs[i]-10, padT + plotH + 18);
    }
    ctx.restore();
  }

  function trCell(text, alignRight=false){
    const td = document.createElement("td");
    td.textContent = text;
    td.style.padding = "10px";
    td.style.borderBottom = "1px solid #e5e7eb";
    td.style.textAlign = alignRight ? "right" : "left";
    return td;
  }

  function fmtRatio(x){
    if(x === null || x === undefined) return "-";
    const v = Math.round(x * 1000) / 10; // 0.1% 단위
    return v.toFixed(1) + "%";
  }

  async function loadAll(){
    tbody.innerHTML = "";
    notesBox.textContent = "회차별 메모를 불러오는 중…";
    paramsBox.textContent = "";

    const results = [];
    const allNotes = [];
    const allParams = {};

    for(const sid of sids){
      const url = `/analysis/class/${code}/${sid}/dbscan_structure.json`;
      try{
        const r = await fetch(url);
        const payload = await r.json();

        const c = payload.counts || {};
        const n = payload.n_points ?? (payload.points ? payload.points.length : 0);
        const isoRatio = c.isolated_ratio ?? (n ? ((c.isolated||0)/n) : 0);

        results.push({
          sid,
          n,
          dense: c.dense ?? 0,
          boundary: c.boundary ?? 0,
          isolated: c.isolated ?? 0,
          isoRatio,
          clusterCount: c.cluster_count ?? ((c.cluster_sizes||[]).length),
          clusterSizes: c.cluster_sizes ?? [],
        });

        const notes = payload.notes || [];
        if(notes.length){
          allNotes.push(`${sid}차: ${notes.join(" / ")}`);
        }

        allParams[sid] = payload.params || {};
      }catch(e){
        results.push({ sid, n: 0, dense: 0, boundary: 0, isolated: 0, isoRatio: 0, clusterCount: 0, clusterSizes: []});
        allNotes.push(`${sid}차: 데이터를 불러오지 못했습니다.`);
      }
    }

    // 표 채우기
    for(const r of results){
      const tr = document.createElement("tr");

      tr.appendChild(trCell(r.sid + "차"));
      tr.appendChild(trCell(String(r.n), true));
      tr.appendChild(trCell(String(r.dense), true));
      tr.appendChild(trCell(String(r.boundary), true));
      tr.appendChild(trCell(String(r.isolated), true));
      tr.appendChild(trCell(fmtRatio(r.isoRatio), true));
      tr.appendChild(trCell(String(r.clusterCount), true));
      tr.appendChild(trCell((r.clusterSizes && r.clusterSizes.length) ? r.clusterSizes.join(", ") : "-", false));

      tbody.appendChild(tr);
    }

    // 트렌드(고립 비율)
    drawTrend(results.map(r => ({sid: r.sid, isoRatio: r.isoRatio})));

    // 메모
    notesBox.textContent = allNotes.length ? allNotes.join(" | ") : "특이 메모 없음";

    // 파라미터(재현)
    paramsBox.textContent = JSON.stringify(allParams, null, 2);
  }

  loadAll();
})();
</script>
{% endblock %}
