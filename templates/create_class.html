{% extends "base.html" %}
{% block content %}
<div class="card">
  <h2>학급 생성</h2>
  <form method="post">
    학급 이름<br>
    <input name="class_name" placeholder="예: 2026학년도 6학년 1반"><br><br>

    학생 명단(엑셀이나 구글시트에서 붙여넣기)<br>
    <div style="text-align:left; margin-top:8px;">
      <style>
        .grid-wrap{ border:1px solid #d7dbe7; border-radius:10px; overflow:hidden; background:#fff; }
        table.student-grid{ width:100%; border-collapse:collapse; table-layout:fixed; }
        table.student-grid th, table.student-grid td{ border-bottom:1px solid #eef1f7; border-right:1px solid #eef1f7; padding:8px; }
        table.student-grid th:last-child, table.student-grid td:last-child{ border-right:none; }
        table.student-grid tr:last-child td{ border-bottom:none; }
        table.student-grid th{ background:#f6f8ff; font-size:13px; text-align:left; }
        .grid-input{ width:100%; padding:8px; border-radius:8px; border:1px solid #cfd6ea; box-sizing:border-box; font-size:14px; }
        .grid-actions{ display:flex; gap:8px; margin-top:10px; }
        .grid-actions button{ width:auto; padding:10px 14px; font-size:14px; }
        .hint{ font-size:12px; color:#666; margin-top:8px; line-height:1.5; }
      </style>

      <div class="grid-wrap">
        <table class="student-grid" aria-label="학생 명단 입력 표">
          <thead>
            <tr>
              <th style="width:90px;">번호</th>
              <th>이름</th>
              <th style="width:120px;">성별</th>
            </tr>
          </thead>
          <tbody id="studentGridBody">
            <!-- JS로 기본 20줄 생성 -->
          </tbody>
        </table>
      </div>

      <div class="grid-actions">
        <button type="button" id="addRowBtn">줄(학생) 추가</button>
      </div>

      <div class="hint">
        - 기본으로 20줄(20명)을 제공합니다. 더 필요하면 “줄(학생) 추가”를 누르세요.<br>
        - <b>이름이 비어있는 줄</b>은 자동으로 제외됩니다.<br>
      </div>
    </div>

    <!-- 서버로 전달되는 값 -->
    <textarea name="students" id="students_hidden" style="display:none;"></textarea>

    <br>
    <button>생성</button>
  </form>
</div>

<script>
(function(){
  const body = document.getElementById('studentGridBody');
  const addRowBtn = document.getElementById('addRowBtn');
  const hidden = document.getElementById('students_hidden');
  const formEl = document.querySelector('form');

  function makeRow(idx){
    const tr = document.createElement('tr');

    const tdNo = document.createElement('td');
    const no = document.createElement('input');
    no.type = 'text';
    no.className = 'grid-input';
    no.value = String(idx);
    no.placeholder = '예: 1';
    tdNo.appendChild(no);

    const tdName = document.createElement('td');
    const nm = document.createElement('input');
    nm.type = 'text';
    nm.className = 'grid-input';
    nm.placeholder = '예: 홍길동';
    tdName.appendChild(nm);

    const tdGender = document.createElement('td');
    const g = document.createElement('input');
    g.type = 'text';
    g.className = 'grid-input';
    g.placeholder = '예: 남 / 여';
    tdGender.appendChild(g);

    tr.appendChild(tdNo);
    tr.appendChild(tdName);
    tr.appendChild(tdGender);
    return tr;
  }

  function initRows(n){
    for(let i=1;i<=n;i++) body.appendChild(makeRow(i));
  }

  function serializeStudents(){
    const lines = [];
    const rows = body.querySelectorAll('tr');

    for(let idx = 0; idx < rows.length; idx++){
      const inputs = rows[idx].querySelectorAll('input');

      const noInput = inputs[0];
      const nameInput = inputs[1];
      const genderInput = inputs[2];

      const name = (nameInput.value || '').trim();
      if(!name) continue;

      let no = (noInput.value || '').trim();
      if(!no) no = String(idx + 1);

      const gender = (genderInput.value || '').trim();
      if(!gender){
        genderInput.focus();
        alert(`${idx + 1}번째 줄: 성별이 입력되지 않았습니다. (남 / 여)`);
        throw new Error("gender_required");
      }

      lines.push(`${no}\t${name}\t${gender}`);
    }

    hidden.value = lines.join('\n');
  }

  if(formEl){
    formEl.addEventListener('submit', (e) => {
      try{
        serializeStudents();
      }catch(err){
        e.preventDefault();
      }
    });
  }

  initRows(20);

  addRowBtn.addEventListener('click', () => {
    const nextIdx = body.querySelectorAll('tr').length + 1;
    body.appendChild(makeRow(nextIdx));
  });

  // 엑셀 / 구글시트 / 한글 표 복붙 지원
  body.addEventListener('paste', (e) => {
    const target = e.target;
    if(!(target instanceof HTMLInputElement)) return;

    const tr = target.closest('tr');
    if(!tr) return;

    const rows = Array.from(body.querySelectorAll('tr'));
    const rowIndex = rows.indexOf(tr);
    if(rowIndex < 0) return;

    const inputs = Array.from(tr.querySelectorAll('input'));
    const colIndex = inputs.indexOf(target);
    if(colIndex < 0) return;

    const text = (e.clipboardData || window.clipboardData)?.getData('text');
    if(!text) return;

    const lines = text.replace(/\r/g, '').split('\n').filter(Boolean);
    if(lines.length === 0) return;

    e.preventDefault();

    while(body.querySelectorAll('tr').length < rowIndex + lines.length){
      const nextIdx = body.querySelectorAll('tr').length + 1;
      body.appendChild(makeRow(nextIdx));
    }

    lines.forEach((line, rOffset) => {
      const cols = line.split('\t');
      const row = body.querySelectorAll('tr')[rowIndex + rOffset];
      const rowInputs = row.querySelectorAll('input');

      if(cols.length >= 3){
        rowInputs[0].value = cols[0].trim();
        rowInputs[1].value = cols[1].trim();
        rowInputs[2].value = cols[2].trim();
      } else if(cols.length === 2){
        rowInputs[0].value = cols[0].trim();
        rowInputs[1].value = cols[1].trim();
      } else {
        rowInputs[colIndex].value = cols[0].trim();
      }
    });
  });
})();
</script>
{% endblock %}
