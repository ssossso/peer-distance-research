{% extends "base.html" %}
{% block content %}
<div class="card" style="max-width:980px; text-align:left;">
  <h2 style="margin:0 0 6px 0; text-align:center;">
    {{ "ì„ ìƒë‹˜ì´ ë³¸ ìš°ë¦¬ ë°˜" }}
  </h2>

  <p style="margin:0 0 14px 0; text-align:center;">
    <b>{{ run.teacher_username }}</b>
    <span class="muted" style="margin-left:8px;">
      {{ run.session_id }}ì°¨
    </span>
  {% if run.submitted %}
    <span class="status" style="margin-left:8px;">ë§ˆë¬´ë¦¬ ì™„ë£Œ</span>
  {% elif placements_complete %}
    <span class="status" style="margin-left:8px;">ë°°ì¹˜ ì €ì¥ë¨</span>
  {% else %}
    <span class="muted" style="margin-left:8px;">ì‘ì„± ì¤‘</span>
  {% endif %}
  </p>

  <div class="subtitle" style="text-align:left; margin-bottom:12px;">
    í•™ìƒ ëª©ë¡ì˜ í•™ìƒ ì´ë¦„ì„ ê·¸ëŒ€ë¡œ ëŒì–´ì„œ ì•„ë˜ ê³µê°„ì— ë†“ì•„ ì£¼ì„¸ìš”. ì„œë¡œ ê°€ê¹Œìš¸ìˆ˜ë¡ êµì‚¬ê°€ ë³´ê¸°ì— ì¹œë°€í•œ ê´€ê³„ì…ë‹ˆë‹¤.
    <div style="margin-top:6px; font-weight:800;">
      ëª¨ë“  í•™ìƒì„ ë°°ì¹˜í•´ ì£¼ì„¸ìš”.
    </div>
  </div>

  {% if error %}
    <div class="error">{{ error }}</div>
  {% endif %}

  <!--
    í•œ í˜ì´ì§€ í†µí•©:
    - ë°°ì¹˜ ì €ì¥(ê¸°ì¡´): /teacher/placement/{{ run.id }}  (í˜„ì¬ ë¼ìš°íŠ¸)
    - ê¸°ë¡ ë§ˆë¬´ë¦¬ ì €ì¥(ê¸°ì¡´ complete ë¼ìš°íŠ¸ ìœ ì§€): /teacher/placement/{{ run.id }}/complete
    ì•„ë˜ formì€ ê¸°ë³¸ actionì„ í˜„ì¬ í˜ì´ì§€ë¡œ ë‘ê³ , "ê¸°ë¡ ì €ì¥" í´ë¦­ ì‹œ JSì—ì„œ actionì„ completeë¡œ ë³€ê²½í•©ë‹ˆë‹¤.
  -->
  <form method="post" id="measureForm" onsubmit="return onSubmitMeasure();">
    <input type="hidden" name="placements_json" id="placements_json" value="">

    <!-- ë§ˆë¬´ë¦¬ ë‹¨ê³„ ì…ë ¥(complete ë¼ìš°íŠ¸ì— ì „ì†¡) -->
    <input type="hidden" name="confidence_score" id="confidence_score" value="50">
    <input type="hidden" name="priority_1" id="priority_1" value="">
    <input type="hidden" name="priority_2" id="priority_2" value="">
    <input type="hidden" name="priority_3" id="priority_3" value="">

    <div style="display:grid; grid-template-columns: 1fr 260px; gap:12px; align-items:start;">
      <!-- ìº”ë²„ìŠ¤ -->
      <div>
        <div id="canvas"
             style="position:relative; height:clamp(360px, 62vh, 520px);
                    border:1px solid #d1d5db; border-radius:12px;
                    background:#fff; overflow:hidden; touch-action:none;">
        </div>

        <div class="muted" style="margin-top:8px; font-size:12px;">
          íŒ: ì™¼ìª½/ìœ„ìª½/ì˜¤ë¥¸ìª½/ì•„ë˜ìª½ ë°©í–¥ì€ ìƒê´€ ì—†ì´ ì„œë¡œì— ëŒ€í•œ ê±°ë¦¬ë§Œ ìƒê°í•˜ì‹œë©´ ë©ë‹ˆë‹¤.
          (ì´ í™”ë©´ì€ ì •ë‹µì„ ì°¾ê±°ë‚˜ í•™ìƒì„ íŒë‹¨Â·ì§„ë‹¨í•˜ê¸° ìœ„í•œ ê²ƒì´ ì•„ë‹™ë‹ˆë‹¤. êµì‚¬ì˜ ê´€ì°°ì„ ì •ë¦¬í•´ ë³´ê³ , í•™ê¸‰ ê´€ê³„ë¥¼ ë‹¤ë¥¸ ê°ë„ì—ì„œ ë°”ë¼ë³´ê¸° ìœ„í•œ ì°¸ê³  ìë£Œì…ë‹ˆë‹¤.)
        </div>
      </div>

      <!-- ì˜¤ë¥¸ìª½ íŒ¨ë„: (A) í•™ìƒ ëª©ë¡ / (B) êµì‚¬ ê´€ê³„ ì¸ì‹(ë§ˆë¬´ë¦¬) -->
      <div style="border:1px solid #e5e7eb; border-radius:12px; padding:10px; background:#fbfbfd;
                  height:clamp(360px, 62vh, 520px); display:flex; flex-direction:column;">

        <!-- (A) í•™ìƒ ëª©ë¡ íŒ¨ë„ -->
        <div id="panel_list" style="display:flex; flex-direction:column; flex:1; min-height:0;">
          <div style="font-weight:800; margin-bottom:10px;">í•™ìƒ ëª©ë¡</div>

          <div id="friendList"
               style="display:grid; grid-template-columns: repeat(3, 1fr); gap:6px;
                      align-content:start; flex:1; min-height:0; overflow:auto; scrollbar-gutter:stable;">
            {% for f in friends %}
              <div class="chip" data-name="{{ f }}"
                   style="user-select:none; cursor:grab; padding:8px 6px;
                          border-radius:10px; border:1px solid #d1d5db;
                          background:#ffffff; font-weight:600;
                          font-size:12.5px; font-family:sans-serif;
                          text-align:center; touch-action:none;">
                {{ f }}
              </div>
            {% endfor %}
          </div>

          <hr style="border:none; border-top:1px solid #e5e7eb; margin:12px 0;">

          <div style="display:flex; gap:8px;">
            {% if run.submitted %}
              <button type="button" disabled style="flex:1; opacity:0.6;">ë§ˆë¬´ë¦¬ ì™„ë£Œ</button>
            {% elif readonly or placements_complete %}
              <a class="btn" href="/teacher/placement/{{ run.id }}?edit=1"
                 style="flex:1; text-align:center; display:inline-flex; align-items:center; justify-content:center;">
                ë°°ì¹˜ ìˆ˜ì •
              </a>
              <a class="btn" href="/teacher/placement/{{ run.id }}/complete"
                 style="flex:1; text-align:center; display:inline-flex; align-items:center; justify-content:center;">
                ë‹¤ìŒ ë‹¨ê³„
              </a>
            {% else %}
              <button type="submit" style="flex:1;">ë°°ì¹˜ ì €ì¥</button>
            {% endif %}
          </div>
        </div>

        <!-- (B) êµì‚¬ ê´€ê³„ ì¸ì‹(ë§ˆë¬´ë¦¬) íŒ¨ë„ -->
        <div id="panel_perception" style="display:none; flex-direction:column; flex:1; min-height:0;">
          <div style="font-weight:900; margin-bottom:6px;">êµì‚¬ ê´€ê³„ ì¸ì‹</div>
          <div class="muted" style="font-size:12px; line-height:1.4; margin-bottom:12px;">
            ì†Œíˆê°€ ë…¼ë¬¸ì— ì¨ë¨¹ì„ ìˆ˜ë„ ìˆëŠ” ê±°>< ëŒ€ì¶© ë¶€ë‹´ ì—†ì´ ë‹µ í•´ì£¼ì„¸ìš”ğŸ™‚ ì§„ì§œ ê³ ë§ˆì›Œìš”ğŸ’™
          </div>

          <!-- í™•ì‹ ë„ -->
          <div style="border:1px solid #e5e7eb; border-radius:12px; background:#fff; padding:10px; margin-bottom:10px;">
            <div style="font-weight:800; margin-bottom:8px;">í™•ì‹ ë„</div>
            <div style="display:flex; justify-content:space-between; font-size:12px; color:#6b7280; margin:0 2px 3px 2px;">
              <span>0</span><span>100</span>
            </div>
            <input id="confidence_slider" type="range" min="0" max="100" value="50" style="width:100%;">
          </div>

          <!-- ê¹ƒë°œ(ìš°ì„ ìˆœìœ„) -->
          <div style="border:1px solid #e5e7eb; border-radius:12px; background:#fff; padding:10px; margin-bottom:10px;">
            <div class="tp-title-2line">ë˜ë˜ê´€ê³„(ê°ˆë“±Â·ê³ ë¦½) ì¸¡ë©´ì—ì„œ ì¶”ê°€ë¡œ ì‚´í´ë³¼ í•„ìš”ê°€ ìˆë‹¤ê³ <br>ëŠë‚€ í•™ìƒ ì„ íƒ</div>

            <div style="display:flex; gap:10px; align-items:stretch; margin-bottom:8px;">
              <button type="button" class="rankBtn" data-rank="1"
                      style="flex:1; padding:10px 0; border-radius:12px; border:1px solid #d1d5db; background:#ffffff;
                             font-weight:850; font-size:13px; cursor:pointer; color:#111827;">
                1ìˆœìœ„
              </button>
              <button type="button" class="rankBtn" data-rank="2"
                      style="flex:1; padding:10px 0; border-radius:12px; border:1px solid #d1d5db; background:#ffffff;
                             font-weight:850; font-size:13px; cursor:pointer; color:#111827;">
                2ìˆœìœ„
              </button>
              <button type="button" class="rankBtn" data-rank="3"
                      style="flex:1; padding:10px 0; border-radius:12px; border:1px solid #d1d5db; background:#ffffff;
                             font-weight:850; font-size:13px; cursor:pointer; color:#111827;">
                3ìˆœìœ„
              </button>
            </div>

            <div class="muted" style="font-size:12px; line-height:1.45;">
              ìˆœìœ„ ì„ íƒ â†’ ì™¼ìª½ì—ì„œ í•™ìƒ ì´ë¦„
            </div>
          </div>

          <!-- ì €ì¥ -->
          <div style="display:flex; gap:8px; margin-top:auto;">
            <button type="button" class="tp-btn tp-btn-secondary" id="btnBack">
              ëŒì•„ê°€ê¸°
            </button>
            <button type="submit" class="tp-btn tp-btn-primary" id="btnSave">ê¸°ë¡ ì €ì¥</button>
          </div>
        </div>

      </div>
    </div>
  </form>
</div>

<style>
  /* í´ë¦­/í„°ì¹˜ ì‹œ ì»¤ì§€ëŠ” íš¨ê³¼ ë°©ì§€ */
  .chip, .token {
    transform: none !important;
    -webkit-tap-highlight-color: transparent;
    transition: none !important;
  }
  .chip:active, .token:active { transform: none !important; }

  /* ë§ˆë¬´ë¦¬ ë‹¨ê³„ì—ì„œ í´ë¦­ ê°€ëŠ¥í•œ í† í° ëŠë‚Œ */
  .token.clickable { cursor: pointer !important; }
  .token .flag {
    position:absolute;
    left:50%;
    top:-12px;
    transform:translate(-50%, -100%);
    font-size:11px;
    font-weight:850;
    padding:2px 6px;
    border-radius:999px;
    background:rgba(255,255,255,0.95);
    border:1px solid #d1d5db;
    display:none;
    pointer-events:none;
    white-space:nowrap;
  }

  /* -------------------------------------------------
     Teacher placement unified buttons
     - Same size/shape for: ë°°ì¹˜ ìˆ˜ì • / ë‹¤ìŒ ë‹¨ê³„ / ëŒì•„ê°€ê¸° / ê¸°ë¡ ì €ì¥
  ------------------------------------------------- */
  .tp-btn{
    width:100%;
    height:44px;
    padding:0 14px;
    border-radius:12px;
    border:1px solid #d1d5db;
    background:#ffffff;
    color:#111827;
    font-weight:900;
    font-size:14px;
    line-height:1;
    display:inline-flex;
    align-items:center;
    justify-content:center;
    text-decoration:none;
    box-sizing:border-box;
    cursor:pointer;
  }
  .tp-btn:hover{ border-color:#9ca3af; }
  .tp-btn-primary{
    background:#4a6cf7;
    border-color:#4a6cf7;
    color:#ffffff;
  }
  .tp-btn-primary:hover{
    background:#3955c6;
    border-color:#3955c6;
  }
  .tp-btn:disabled{
    opacity:0.55;
    cursor:not-allowed;
  }
  .tp-title-2line{
    font-weight:900;
    font-size:13px;
    line-height:1.35;
    margin-bottom:8px;
  }
  .rankBtn{
    color:#111827 !important;
  }

</style>

<script>
  const READONLY = {{ 'true' if (run.submitted or readonly) else 'false' }};
  const friends = {{ friends|tojson }};
  const initialPlacements = {{ placements|tojson }};

  const canvas = document.getElementById('canvas');
  const friendList = document.getElementById('friendList');
  const placementsInput = document.getElementById('placements_json');

  const panelList = document.getElementById('panel_list');
  const panelPerception = document.getElementById('panel_perception');
  const btnNextStep = document.getElementById('btnNextStep');
  const btnBack = document.getElementById('btnBack');
  const btnSavePerception = document.getElementById('btnSavePerception');

  const confidenceSlider = document.getElementById('confidence_slider');
  const confidenceHidden = document.getElementById('confidence_score');

  const h1 = document.getElementById('priority_1');
  const h2 = document.getElementById('priority_2');
  const h3 = document.getElementById('priority_3');

  function clamp(v, min, max){ return Math.min(Math.max(v, min), max); }
  const EDGE_MARGIN = 6;

  // ë§ˆë¬´ë¦¬ ë‹¨ê³„ ìƒíƒœ
  let PERCEPTION_STEP = false;

  // ìš°ì„ ìˆœìœ„(ê¹ƒë°œ): ê° ìˆœìœ„ëŠ” í•œ ëª…ë§Œ
  const ranks = {1: null, 2: null, 3: null}; // í•™ìƒ ì´ë¦„
  let activeRank = null;

  function syncHidden(){
    h1.value = ranks[1] || "";
    h2.value = ranks[2] || "";
    h3.value = ranks[3] || "";
    confidenceHidden.value = String(Number(confidenceSlider?.value ?? 50));
  }

  function setActiveRank(r){
    activeRank = r;
    document.querySelectorAll('.rankBtn').forEach(btn => {
      const rr = Number(btn.dataset.rank);
      const on = (rr === activeRank);
      btn.style.borderColor = on ? '#111827' : '#d1d5db';
      btn.style.boxShadow = on ? '0 0 0 3px rgba(17, 24, 39, 0.10)' : 'none';
      btn.style.background = on ? '#f9fafb' : '#ffffff';
    });
  }

  document.querySelectorAll('.rankBtn').forEach(btn => {
    btn.addEventListener('click', () => setActiveRank(Number(btn.dataset.rank)));
  });

  confidenceSlider?.addEventListener('input', () => syncHidden());

  function makeToken(name){
    const el = document.createElement('div');
    el.className = 'token';
    el.dataset.name = name;

    el.style.fontWeight = '600';
    el.style.fontSize = '12.5px';
    el.style.fontFamily = 'sans-serif';

    el.style.position = 'absolute';
    el.style.left = '0px';
    el.style.top = '0px';

    el.style.touchAction = 'none';
    el.style.userSelect = 'none';
    el.style.cursor = 'grab';

    // ê¹ƒë°œ(ë§ˆë¬´ë¦¬ ë‹¨ê³„ í‘œì‹œìš©)
    const flag = document.createElement('div');
    flag.className = 'flag';
    el.appendChild(flag);

    // í…ìŠ¤íŠ¸
    const txt = document.createElement('div');
    txt.textContent = name;
    el.appendChild(txt);

    if (!READONLY) attachDrag(el);

    // ë§ˆë¬´ë¦¬ ë‹¨ê³„ì—ì„œë§Œ í´ë¦­ìœ¼ë¡œ ìˆœìœ„ ì§€ì •
    el.addEventListener('click', () => {
      if (!PERCEPTION_STEP) return;
      if (!activeRank) return;

      const nm = el.dataset.name;

      // í† ê¸€: ê°™ì€ í•™ìƒì´ë©´ í•´ì œ
      if (ranks[activeRank] === nm) ranks[activeRank] = null;
      else ranks[activeRank] = nm;

      syncHidden();
      refreshFlags();
    });

    return el;
  }

  function attachDrag(el){
    let dragging = false;
    let offsetX = 0, offsetY = 0;

    el.addEventListener('pointerdown', (e) => {
      if (READONLY) return;
      dragging = true;
      el.setPointerCapture?.(e.pointerId);
      el.style.cursor = 'grabbing';
      el.style.transform = 'none';

      const r = el.getBoundingClientRect();
      offsetX = e.clientX - r.left;
      offsetY = e.clientY - r.top;
      e.preventDefault();
    });

    el.addEventListener('pointermove', (e) => {
      if (!dragging) return;
      const c = canvas.getBoundingClientRect();
      let x = e.clientX - c.left - offsetX;
      let y = e.clientY - c.top - offsetY;

      x = clamp(x, EDGE_MARGIN, c.width - el.offsetWidth - EDGE_MARGIN);
      y = clamp(y, EDGE_MARGIN, c.height - el.offsetHeight - EDGE_MARGIN);

      el.style.left = x + 'px';
      el.style.top = y + 'px';
      syncPlacements();
      e.preventDefault();
    });

    el.addEventListener('pointerup', (e) => {
      if (!dragging) return;
      dragging = false;
      el.style.cursor = 'grab';

      // If dropped over student list, return to list
      const fl = friendList.getBoundingClientRect();
      const inFriendList =
        (e.clientX >= fl.left && e.clientX <= fl.right && e.clientY >= fl.top && e.clientY <= fl.bottom);

      if (inFriendList){
        const n = el.dataset.name;
        el.remove();
        if (window.addChipBack) window.addChipBack(n);
        syncPlacements();
        return;
      }

      syncPlacements();
    });
  }

  /**
   * ì €ì¥ ìŠ¤í‚¤ë§ˆ(êµì‚¬ ë°°ì¹˜):
   * - ì¤‘ì‹¬ì  ê¸°ì¤€ì´ ì•„ë‹ˆë¼ ìº”ë²„ìŠ¤ ë‚´ë¶€ ì ˆëŒ€ì¢Œí‘œë¡œ ì €ì¥
   * - x, yëŠ” "ìº”ë²„ìŠ¤ ë‚´ token ì¤‘ì‹¬ì " (pixel)
   * - w, hëŠ” ìº”ë²„ìŠ¤ í¬ê¸° (pixel) ì €ì¥ (í›„ì²˜ë¦¬ì—ì„œ ì •ê·œí™”/ì¬í˜„ì— ë„ì›€)
   * - mode: 'abs'ë¡œ ëª…ì‹œ
   */
  function syncPlacements(){
    const cRect = canvas.getBoundingClientRect();
    const out = {};
    const tokens = canvas.querySelectorAll('.token');

    tokens.forEach(t => {
      const cx = parseFloat(t.style.left || '0') + t.offsetWidth/2;
      const cy = parseFloat(t.style.top || '0') + t.offsetHeight/2;
      out[t.dataset.name] = {
        x: Math.round(cx*100)/100,
        y: Math.round(cy*100)/100,
        w: Math.round(cRect.width*100)/100,
        h: Math.round(cRect.height*100)/100,
        mode: 'abs'
      };
    });

    placementsInput.value = JSON.stringify(out);
    return out;
  }

  function onSubmitMeasure(){
    // ë§ˆë¬´ë¦¬ ë‹¨ê³„ì—ì„œ "ê¸°ë¡ ì €ì¥"ì„ ëˆ„ë¥¸ ê²½ìš°:
    if (PERCEPTION_STEP){
      // complete ë¼ìš°íŠ¸ë¡œ ì „ì†¡
      const form = document.getElementById('measureForm');
      form.action = "/teacher/placement/{{ run.id }}/complete";
      syncHidden();
      syncPlacements();
      return true;
    }

    // ì¼ë°˜ ë°°ì¹˜ ì €ì¥(ê¸°ì¡´)
    if (READONLY) return false;

    const p = syncPlacements();
    const missing = friends.filter(n => !p[n]);

    if (missing.length > 0){
      alert('ì•„ì§ ë°°ì¹˜ë˜ì§€ ì•Šì€ í•™ìƒì´ ìˆìŠµë‹ˆë‹¤. ëª¨ë“  í•™ìƒì„ ë°°ì¹˜í•œ í›„ ì €ì¥í•´ ì£¼ì„¸ìš”.\n\në¯¸ë°°ì¹˜: ' + missing.join(', '));
      return false;
    }

    return confirm('ë°°ì¹˜ë¥¼ ì €ì¥í•˜ê³  ë‹¤ìŒ ë‹¨ê³„(í™•ì‹ ë„/ìš°ì„ ìˆœìœ„ ì…ë ¥)ë¡œ ì´ë™í• ê¹Œìš”?');
  }

  function refreshFlags(){
    const tokens = canvas.querySelectorAll('.token');
    tokens.forEach(t => {
      const nm = t.dataset.name;
      const flag = t.querySelector('.flag');
      if (!flag) return;

      let r = null;
      if (ranks[1] === nm) r = 1;
      else if (ranks[2] === nm) r = 2;
      else if (ranks[3] === nm) r = 3;

      if (r){
        flag.style.display = 'block';
        flag.textContent = r + 'ìœ„';
        flag.style.borderColor = '#111827';
      } else {
        flag.style.display = 'none';
        flag.textContent = '';
        flag.style.borderColor = '#d1d5db';
      }
    });
  }

  function setPerceptionMode(on){
    PERCEPTION_STEP = on;

    if (on){
      panelList.style.display = 'none';
      panelPerception.style.display = 'flex';

      // í† í° í´ë¦­ ê°€ëŠ¥ í‘œì‹œ
      canvas.querySelectorAll('.token').forEach(t => t.classList.add('clickable'));
      syncHidden();
      refreshFlags();
    } else {
      panelPerception.style.display = 'none';
      panelList.style.display = 'flex';
      canvas.querySelectorAll('.token').forEach(t => t.classList.remove('clickable'));
    }
  }

  btnNextStep?.addEventListener('click', () => setPerceptionMode(true));
  btnBack?.addEventListener('click', () => setPerceptionMode(false));

  /**
   * ì´ˆê¸° ë°°ì¹˜ ë³µì› (í•˜ìœ„í˜¸í™˜ í¬í•¨)
   * - ì‹ ê·œ: {name: {x, y, mode:'abs', ...}}  => x,yë¥¼ ì ˆëŒ€ì¢Œí‘œë¡œ ì‚¬ìš©
   * - êµ¬ë²„ì „: {name: {x(rel), y(rel), d, ...}} => ì¤‘ì‹¬ì  ê¸°ì¤€ ìƒëŒ€ì¢Œí‘œë¡œ í•´ì„í•˜ê³  ì ˆëŒ€ì¢Œí‘œë¡œ ë³€í™˜
   */
  function restoreInitial(){
    const cRect = canvas.getBoundingClientRect();
    const center = { x: cRect.width/2, y: cRect.height/2 };

    // Remove chips that are already placed
    const chips = friendList ? Array.from(friendList.querySelectorAll('.chip')) : [];
    chips.forEach(chip => {
      const n = chip.dataset.name;
      if (initialPlacements && initialPlacements[n]){
        chip.remove();
      }
    });

    if (initialPlacements){
      Object.keys(initialPlacements).forEach((n) => {
        const v = initialPlacements[n];
        const token = makeToken(n);

        // determine absolute center position
        let absCx = null, absCy = null;

        if (v && v.mode === 'abs' && typeof v.x === 'number' && typeof v.y === 'number'){
          // new absolute storage
          absCx = v.x;
          absCy = v.y;
        } else if (v && typeof v.x === 'number' && typeof v.y === 'number'){
          // backward compatibility: treat x,y as relative-to-center
          absCx = center.x + v.x;
          absCy = center.y + v.y;
        } else {
          // fallback: place near center
          absCx = center.x;
          absCy = center.y;
        }

        // convert center to top-left
        const px = clamp(absCx - token.offsetWidth/2, EDGE_MARGIN, cRect.width - token.offsetWidth - EDGE_MARGIN);
        const py = clamp(absCy - token.offsetHeight/2, EDGE_MARGIN, cRect.height - token.offsetHeight - EDGE_MARGIN);
        token.style.left = px + 'px';
        token.style.top = py + 'px';
        canvas.appendChild(token);
      });
    }
    syncPlacements();
  }

  function enableChipDragToCanvas(){
    if (!friendList) return;

    let draggingChip = null;
    let placeholder = null;
    let offsetX = 0, offsetY = 0;
    let originParent = null;
    let didDrop = false;
    let activePointerId = null;

    function resetChipStyles(chip){
      chip.style.position = '';
      chip.style.left = '';
      chip.style.top = '';
      chip.style.zIndex = '';
      chip.style.width = '';
      chip.style.height = '';
      chip.style.transform = '';
      chip.style.cursor = 'grab';
      chip.style.opacity = '';
    }

    function cleanup(){
      if (!draggingChip) return;

      window.removeEventListener('pointermove', onMove, { passive: false });
      window.removeEventListener('pointerup', onUp, { passive: false });
      window.removeEventListener('pointercancel', onCancel);

      try { draggingChip?.releasePointerCapture(activePointerId); } catch (e) {}

      if (!didDrop){
        resetChipStyles(draggingChip);
        if (placeholder && originParent){
          originParent.insertBefore(draggingChip, placeholder);
          placeholder.remove();
        }
      } else {
        placeholder?.remove();
      }

      placeholder = null;
      originParent = null;
      draggingChip = null;
      didDrop = false;
      activePointerId = null;
    }

    function placeTokenFromChip(chip, clientX, clientY){
      const name = chip.dataset.name;
      const c = canvas.getBoundingClientRect();
      const token = makeToken(name);

      let x = clientX - c.left - offsetX;
      let y = clientY - c.top - offsetY;

      x = clamp(x, EDGE_MARGIN, c.width - token.offsetWidth - EDGE_MARGIN);
      y = clamp(y, EDGE_MARGIN, c.height - token.offsetHeight - EDGE_MARGIN);

      token.style.left = x + 'px';
      token.style.top = y + 'px';
      canvas.appendChild(token);
      syncPlacements();
    }

    function addChipBack(name){
      if (READONLY) return;
      const exists = Array.from(friendList.querySelectorAll('.chip')).some(c => c.dataset.name === name);
      if (exists) return;

      const chip = document.createElement('div');
      chip.className = 'chip';
      chip.dataset.name = name;

      chip.style.userSelect = 'none';
      chip.style.cursor = 'grab';
      chip.style.padding = '8px 6px';
      chip.style.borderRadius = '10px';
      chip.style.border = '1px solid #d1d5db';
      chip.style.background = '#ffffff';
      chip.style.fontWeight = '600';
      chip.style.fontSize = '12.5px';
      chip.style.fontFamily = 'sans-serif';
      chip.style.textAlign = 'center';
      chip.style.touchAction = 'none';
      chip.textContent = name;

      const chips = Array.from(friendList.querySelectorAll('.chip'));
      const myIdx = friends.indexOf(name);
      let inserted = false;
      for (const c of chips){
        const idx = friends.indexOf(c.dataset.name);
        if (idx > myIdx){
          friendList.insertBefore(chip, c);
          inserted = true;
          break;
        }
      }
      if (!inserted) friendList.appendChild(chip);
    }
    window.addChipBack = addChipBack;

    function onMove(e){
      if (!draggingChip) return;
      draggingChip.style.left = (e.clientX - offsetX) + 'px';
      draggingChip.style.top = (e.clientY - offsetY) + 'px';
      e.preventDefault();
    }

    function onUp(e){
      if (!draggingChip) return;

      const c = canvas.getBoundingClientRect();
      const inCanvas = (e.clientX >= c.left && e.clientX <= c.right && e.clientY >= c.top && e.clientY <= c.bottom);

      if (inCanvas){
        placeTokenFromChip(draggingChip, e.clientX, e.clientY);
        draggingChip.remove();
        didDrop = true;
      }

      cleanup();
      e.preventDefault();
    }

    function onCancel(){
      cleanup();
    }

    friendList.addEventListener('pointerdown', (e) => {
      if (READONLY) return;
      const chip = e.target.closest('.chip');
      if (!chip) return;

      draggingChip = chip;
      didDrop = false;
      activePointerId = e.pointerId;

      const r = chip.getBoundingClientRect();
      offsetX = e.clientX - r.left;
      offsetY = e.clientY - r.top;

      originParent = chip.parentElement;
      placeholder = document.createElement('div');
      placeholder.style.width = r.width + 'px';
      placeholder.style.height = r.height + 'px';
      placeholder.style.boxSizing = 'border-box';
      placeholder.style.borderRadius = '10px';
      placeholder.style.border = '1px dashed #e5e7eb';
      placeholder.style.background = '#ffffff';
      originParent.insertBefore(placeholder, chip);

      chip.style.position = 'fixed';
      chip.style.left = (e.clientX - offsetX) + 'px';
      chip.style.top = (e.clientY - offsetY) + 'px';
      chip.style.zIndex = '9999';
      chip.style.width = r.width + 'px';
      chip.style.height = r.height + 'px';
      chip.style.cursor = 'grabbing';
      chip.style.opacity = '0.98';
      chip.style.transform = 'translateZ(0)';
      document.body.appendChild(chip);

      try { chip.setPointerCapture(e.pointerId); } catch (err) {}

      window.addEventListener('pointermove', onMove, { passive: false });
      window.addEventListener('pointerup', onUp, { passive: false });
      window.addEventListener('pointercancel', onCancel);

      e.preventDefault();
    });
  }

  window.addEventListener('load', () => {
    enableChipDragToCanvas();
    setTimeout(restoreInitial, 0);

    // readonly ìƒíƒœì—ì„œëŠ” ê¸°ë³¸ì ìœ¼ë¡œ ë§ˆë¬´ë¦¬ ë‹¨ê³„ê°€ ì•„ë‹Œ "í•™ìƒ ëª©ë¡" ìƒíƒœë¡œ ì‹œì‘
    setActiveRank(null);
    syncHidden();
  });
</script>

<script>
  // êµì‚¬ ë°°ì¹˜ ì‹œì‘ ì‹œê° ì €ì¥ (complete í˜ì´ì§€ì—ì„œ duration ê³„ì‚°)
  (function(){
    const key = "teacher_run_start_{{ run.id }}";
    if (!sessionStorage.getItem(key)){
      sessionStorage.setItem(key, String(Date.now()));
    }
  })();
</script>

{% endblock %}
