{% extends "base.html" %}
{% block content %}
<div class="card" style="max-width:900px; text-align:left;">
  <h2 style="margin:0 0 10px 0; text-align:center;">êµì‚¬ ë°°ì¹˜ ê¸°ë¡ (ë§ˆë¬´ë¦¬)</h2>

  <div class="subtitle" style="margin-bottom:12px;">
    ì†Œíˆê°€ ë…¼ë¬¸ì— ì¨ë¨¹ì„ ìˆ˜ë„ ìˆëŠ” ê±°>< ëŒ€ì¶© ë¶€ë‹´ ì—†ì´ ë‹µ í•´ì£¼ì„¸ìš”ğŸ™‚ ì§„ì§œ ê³ ë§ˆì›Œìš”ğŸ’™
  </div>

  <form method="post" id="completeForm">

    <!-- í™•ì‹ ë„: ìŠ¬ë¼ì´ë”(0~100 int ì €ì¥) -->
    <div style="border:1px solid #e5e7eb; border-radius:12px; padding:12px; background:#fafafa; margin-bottom:12px;">
      <div style="font-weight:800; margin-bottom:8px;">í™•ì‹ ë„</div>
      <input type="range" name="confidence_score" min="0" max="100" value="50" style="width:100%;">
    </div>

    <!-- ìš°ì„ ìˆœìœ„ ì œì¶œìš© hidden input -->
    <input type="hidden" name="priority_1" id="priority_1" value="">
    <input type="hidden" name="priority_2" id="priority_2" value="">
    <input type="hidden" name="priority_3" id="priority_3" value="">

    <div style="border:1px solid #e5e7eb; border-radius:12px; padding:12px; background:#fafafa; margin-bottom:12px;">
      <div style="font-weight:900; margin-bottom:8px;">ìƒí™œì§€ë„ ê°œì… ìš°ì„ ìˆœìœ„(1~3ìˆœìœ„, ê±´ë„ˆë›°ê¸° ê°€ëŠ¥)</div>

      <!-- êµì‚¬ ë°°ì¹˜ ê²°ê³¼ ë¯¸ë¦¬ë³´ê¸°(ì½ê¸° ì „ìš©) -->
      <div style="border:1px solid #d1d5db; border-radius:12px; background:#fff; overflow:hidden; margin-bottom:10px;">
        <div id="previewCanvas" style="position:relative; height:280px;"></div>
      </div>

      <div style="display:grid; grid-template-columns: 1fr 340px; gap:12px; align-items:start;">
        <!-- ì™¼ìª½: í•™ìƒ ì„ íƒ ëª©ë¡ -->
        <div style="border:1px solid #e5e7eb; border-radius:12px; background:#fff; padding:10px;">
          <div style="font-weight:800; margin-bottom:8px;">í•™ìƒ ì„ íƒ(ìµœëŒ€ 3ëª…)</div>

          <div id="studentPickList"
               style="display:grid; grid-template-columns: repeat(3, 1fr); gap:6px; align-content:start;">
            {% for s in students %}
              <button type="button" class="pickBtn"
                      data-name="{{ s.name }}"
                      style="padding:8px 6px; border-radius:10px; border:1px solid #d1d5db; background:#ffffff; font-weight:650; font-size:12.5px; cursor:pointer;">
                {{ s.name }}
              </button>
            {% endfor %}
          </div>

          <div class="muted" style="font-size:12px; margin-top:8px;">
            ì„ íƒí•˜ë©´ ì˜¤ë¥¸ìª½ ë°•ìŠ¤ì— 1~3ìˆœìœ„ë¡œ ë“¤ì–´ê°€ë©°, ìˆœì„œëŠ” ìœ„/ì•„ë˜ë¡œ ë°”ê¿€ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
          </div>
        </div>

        <!-- ì˜¤ë¥¸ìª½: ì„ íƒ ê²°ê³¼ + ìˆœì„œ ë³€ê²½ + ì €ì¥/ê±´ë„ˆë›°ê¸° -->
        <div style="border:1px solid #e5e7eb; border-radius:12px; background:#fff; padding:10px;">
          <div style="font-weight:800; margin-bottom:8px;">ì„ íƒëœ í•™ìƒ</div>

          <div id="selectedBox" style="display:flex; flex-direction:column; gap:8px;"></div>

          <div style="display:flex; gap:8px; margin-top:10px;">
            <button type="submit" id="saveBtn" style="flex:1;">ê¸°ë¡ ì €ì¥ ë° ì¢…ë£Œ</button>
            <button type="submit" id="skipBtn" style="flex:1; display:none;" name="skip" value="1">ê±´ë„ˆë›°ê¸°</button>
          </div>

          <div class="muted" style="font-size:12px; margin-top:8px;">
            ì•„ë¬´ë„ ì„ íƒí•˜ì§€ ì•Šìœ¼ë©´ <b>ê±´ë„ˆë›°ê¸°</b>ë¡œ ë°”ë¡œ ì¢…ë£Œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
          </div>
        </div>
      </div>
    </div>
  </form>
</div>

<script>
  // -------------------------
  // ì‹œê°„ ì¸¡ì • ë¡œì§ ì œê±°: ì—°êµ¬ ë°ì´í„°ë¡œ ì‚¬ìš©í•˜ì§€ ì•ŠìŒ
  // -------------------------


  // -------------------------
  // ìš°ì„ ìˆœìœ„ ì„ íƒ UI (ìµœëŒ€ 3ëª…)
  // -------------------------
  const selected = []; // ["ì´ë¦„1", "ì´ë¦„2", "ì´ë¦„3"] -> 1~3ìˆœìœ„ ìˆœì„œ
  const selectedBox = document.getElementById('selectedBox');
  const skipBtn = document.getElementById('skipBtn');

  const h1 = document.getElementById('priority_1');
  const h2 = document.getElementById('priority_2');
  const h3 = document.getElementById('priority_3');

  function syncHidden(){
    h1.value = selected[0] || "";
    h2.value = selected[1] || "";
    h3.value = selected[2] || "";

    // ì•„ë¬´ë„ ì„ íƒ ì•ˆ í–ˆì„ ë•Œë§Œ ê±´ë„ˆë›°ê¸° ë²„íŠ¼ ë…¸ì¶œ
    skipBtn.style.display = (selected.length === 0) ? 'inline-flex' : 'none';
  }

  function renderSelected(){
    selectedBox.innerHTML = "";

    if (selected.length === 0){
      const empty = document.createElement('div');
      empty.className = 'muted';
      empty.style.fontSize = '13px';
      empty.textContent = 'ì•„ì§ ì„ íƒëœ í•™ìƒì´ ì—†ìŠµë‹ˆë‹¤. (ì„ íƒí•˜ì§€ ì•Šì•„ë„ ë©ë‹ˆë‹¤)';
      selectedBox.appendChild(empty);
      return;
    }

    selected.forEach((name, idx) => {
      const row = document.createElement('div');
      row.style.display = 'flex';
      row.style.alignItems = 'center';
      row.style.justifyContent = 'space-between';
      row.style.gap = '8px';
      row.style.border = '1px solid #e5e7eb';
      row.style.borderRadius = '12px';
      row.style.padding = '10px';

      const left = document.createElement('div');
      left.innerHTML = `<b>${idx+1}ìˆœìœ„</b> <span style="margin-left:8px;">${name}</span>`;

      const right = document.createElement('div');
      right.style.display = 'inline-flex';
      right.style.gap = '6px';

      const up = document.createElement('button');
      up.type = 'button';
      up.textContent = 'â–²';
      up.disabled = (idx === 0);
      up.style.width = '38px';

      const down = document.createElement('button');
      down.type = 'button';
      down.textContent = 'â–¼';
      down.disabled = (idx === selected.length - 1);
      down.style.width = '38px';

      const remove = document.createElement('button');
      remove.type = 'button';
      remove.textContent = 'ì‚­ì œ';
      remove.style.width = '64px';

      up.addEventListener('click', () => {
        if (idx <= 0) return;
        const tmp = selected[idx-1];
        selected[idx-1] = selected[idx];
        selected[idx] = tmp;
        renderSelected();
        syncHidden();
        highlightSelectedDots();
      });

      down.addEventListener('click', () => {
        if (idx >= selected.length - 1) return;
        const tmp = selected[idx+1];
        selected[idx+1] = selected[idx];
        selected[idx] = tmp;
        renderSelected();
        syncHidden();
        highlightSelectedDots();
      });

      remove.addEventListener('click', () => {
        const pos = selected.indexOf(name);
        if (pos >= 0) selected.splice(pos, 1);
        renderSelected();
        syncHidden();
        updatePickButtons();
        highlightSelectedDots();
      });

      right.appendChild(up);
      right.appendChild(down);
      right.appendChild(remove);

      row.appendChild(left);
      row.appendChild(right);
      selectedBox.appendChild(row);
    });
  }

  function updatePickButtons(){
    document.querySelectorAll('.pickBtn').forEach(btn => {
      const nm = btn.dataset.name;
      if (!nm) return;

      const picked = selected.includes(nm);
      btn.style.opacity = picked ? '0.6' : '1';
      btn.style.borderColor = picked ? '#111827' : '#d1d5db';
    });
  }

  document.querySelectorAll('.pickBtn').forEach(btn => {
    btn.addEventListener('click', () => {
      const nm = btn.dataset.name;
      if (!nm) return;

      if (selected.includes(nm)){
        // í† ê¸€ í•´ì œ
        const pos = selected.indexOf(nm);
        selected.splice(pos, 1);
      } else {
        // ìƒˆ ì„ íƒ
        if (selected.length >= 3) return;
        selected.push(nm);
      }

      renderSelected();
      syncHidden();
      updatePickButtons();
      highlightSelectedDots();
    });
  });

  // -------------------------
  // êµì‚¬ ë°°ì¹˜ ê²°ê³¼ ë¯¸ë¦¬ë³´ê¸°(ì½ê¸° ì „ìš©)
  // -------------------------
  const placements = {{ (run.placements or {})|tojson }};
  const preview = document.getElementById('previewCanvas');

  function makeDot(name){
    const el = document.createElement('div');
    el.textContent = name;
    el.dataset.name = name;

    el.style.position = 'absolute';
    el.style.transform = 'translate(-50%, -50%)';
    el.style.fontSize = '12px';
    el.style.fontWeight = '650';
    el.style.padding = '6px 8px';
    el.style.border = '1px solid #d1d5db';
    el.style.borderRadius = '999px';
    el.style.background = '#fff';
    el.style.whiteSpace = 'nowrap';
    el.style.transition = 'border-color 0.12s ease, box-shadow 0.12s ease, background 0.12s ease';

    return el;
  }

  function renderPreview(){
    preview.innerHTML = "";
    const r = preview.getBoundingClientRect();
    const w = r.width || 1;
    const h = r.height || 1;

    Object.keys(placements || {}).forEach(name => {
      const v = placements[name];
      if (!v || typeof v !== 'object') return;

      const x = v.x, y = v.y;
      const cw = v.w || w;
      const ch = v.h || h;

      if (typeof x !== 'number' || typeof y !== 'number') return;

      // abs ì €ì¥ê°’: (pixel) / (ì €ì¥ ë‹¹ì‹œ ìº”ë²„ìŠ¤ í¬ê¸°) -> ë¹„ìœ¨ -> í˜„ì¬ ë¯¸ë¦¬ë³´ê¸° ìº”ë²„ìŠ¤ë¡œ í™˜ì‚°
      const nx = (cw > 0) ? (x / cw) : 0.5;
      const ny = (ch > 0) ? (y / ch) : 0.5;

      const dot = makeDot(name);
      dot.style.left = (nx * w) + 'px';
      dot.style.top = (ny * h) + 'px';
      preview.appendChild(dot);
    });

    highlightSelectedDots();
  }

  function highlightSelectedDots(){
    const dots = preview.querySelectorAll('[data-name]');
    dots.forEach(dot => {
      const nm = dot.dataset.name;
      const isPicked = selected.includes(nm);

      if (isPicked){
        dot.style.borderColor = '#111827';
        dot.style.boxShadow = '0 0 0 3px rgba(17, 24, 39, 0.12)';
        dot.style.background = '#f9fafb';
      } else {
        dot.style.borderColor = '#d1d5db';
        dot.style.boxShadow = 'none';
        dot.style.background = '#fff';
      }
    });
  }

  // ì´ˆê¸° ë Œë”
  renderSelected();
  syncHidden();
  updatePickButtons();

  // ë ˆì´ì•„ì›ƒì´ ì¡íŒ ë’¤ ê·¸ë¦¬ê¸°
  setTimeout(renderPreview, 0);
  window.addEventListener('resize', () => renderPreview());
</script>
{% endblock %}
